# 校内机器人联赛 手柄信号传输协议

<p align="right">version 1.0.0</p>

## 1. 概述

数据通过ESP32-C3核心板串口下发，由板上丝印标注为TX0的引脚发送。串口基本配置如下：

| 波特率 | 数据位 | 停止位 | 校验位 | 数据流控 |
| :----: | :----: | :----: | :----: | :------: |
| 115200 |   8    |   1    |   无   |    无    |

数据包的构成如下所示，数据包发送间隔40ms。

|  帧头  | 控制器内容 |  帧尾  |
| :----: | :--------: | :----: |
| 1-Byte |  16-Byte   | 1-Byte |

## 2. 帧头和帧尾

帧头为十六位数0xA5，帧尾为十六位数0xA6

## 3. 控制器内容

### 3.1 摇杆、扳机等非二元按键器件的数据内容如下：

摇杆水平行程从最左侧到最右侧为0x0000~0xFFFF；摇杆垂直行程从最上侧到最下侧为0x0000~0xFFFF

扳机行程从未按下到完全按下为0x0000~0x03ff

| 控制器Byte数 |       数据内容       |
| :----------: | :------------------: |
|    Byte0     | 左摇杆水平行程低八位 |
|    Byte1     | 左摇杆水平行程高八位 |
|    Byte2     | 左摇杆垂直行程低八位 |
|    Byte3     | 左摇杆垂直行程高八位 |
|    Byte4     | 右摇杆水平行程低八位 |
|    Byte5     | 右摇杆水平行程高八位 |
|    Byte6     | 右摇杆垂直行程低八位 |
|    Byte7     | 右摇杆垂直行程高八位 |
|    Byte8     |   左扳机行程低八位   |
|    Byte9     |   左扳机行程高八位   |
|    Byte10    |   右扳机行程低八位   |
|    Byte11    |   右扳机行程低八位   |

### 3.2 按键的数据内容如下：

按键内容通过每一Byte中的bit传输。该bit为0表示未按下，1则表示已按下

#### Byte13

| bit0  | bit1  | bit3  | bit4  |  bit6  |  bit7  |
| :---: | :---: | :---: | :---: | :----: | :----: |
| 按键A | 按键B | 按键X | 按键Y | 按键LB | 按键RB |

#### Byte14

|    bit2    |    bit3    |    bit4    |    bit5    |    bit6    |
| :--------: | :--------: | :--------: | :--------: | :--------: |
| 按键"查看" | 按键"菜单" | 按键"Xbox" | 按下左摇杆 | 按下右摇杆 |

#### Byte15

|    bit0    |
| :--------: |
| 按键"分享" |

#### Byte12

方向键可分为九种输入组合，对应此Byte的值如下表所示

| 无输入 | 按上 | 同时按右、上 | 同时按左、上 | 按下 | 同时按右、下 | 同时按左、下 | 按右 | 按左 |
| :----: | :--: | :----------: | :----------: | :--: | :----------: | :----------: | :--: | :--: |
|   0    |  1   |      2       |      8       |  5   |      4       |      6       |  3   |  7   |

## 4. 手柄传输数据包例

为帮助初学者更好理解本协议，以如下一条数据包为例进行分析

```
[14:28:25.568] A5 99 80 AD 80 BD 80 E7 80 00 00 00 00 00 00 10 00 A6
```

💡 开头的 [14:28:25.568] 为时间戳，不是数据的一部分

对该数据包进行分解，得到如下几个部分

| 帧头 | Byte0 | Byte1 | Byte2 | . . . | Byte14 | Byte15 | 帧尾 |
|:---:|:---:|:---:|:---:|:---:|:---:|:---:|:---:|
| 0xA5 | 0x99 | 0x80 | 0xAD | . . . | 0x10 | 0x00 | 0xA6 |

结合上述控制器内容，可知左摇杆水平行程值$JoyLHori$为其低八位与高八位的组合。

而Byte14用二进制表示 (0x10 = 0b00001000)，可得到如下结果

| Bit7 | Bit6 | Bit5 | Bit4 | Bit3 | Bit2 | Bit1 | Bit0 |
| :--: | :--: | :--: | :--: | :--: | :--: | :--: | :--: |
|  0   |  0   |  0   |  0   |  1   |  0   |  0   |  0   |

可以看到，Bit3为1，结合上述控制器内容，按键“Xbox”被按下。
